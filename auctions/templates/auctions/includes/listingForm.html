{% if form_mode == 'preview' %}
    {% url 'preview_listing' as action_url %}
{% elif form_mode == 'edit_existing' %}
    {% url 'edit_listing' as action_url %}
{% endif %}


<div class="container">
    <div class="row">
        <div class="col-md-10">

            {# Display form errors #}
            <div id="formErrors">
                {% if form.non_field_errors %}
                    <div class="row mb-4"><p class="mark">{{ form.non_field_errors }}</p></div>
                {% endif %}
            </div>

            {# Display option to generate a random listing #}
            {% if new_listing %}
                <div class="row mb-4">
                    <label for="randomInput" class="col-form-label col-sm-4 form-check-label">Generate a random listing</label>
                    <div class="col-md-8">
                        <input type="checkbox" class="form-check-input align-bottom mt-2" name="random" id="randomInput">
                    </div>
                </div>
            {% endif %}


            <hr class="my-5"/>
            <p class="lead my-4">Please fill out all fields.</p>

            {# Include the subform for adding images to this listing #}
            {% include 'auctions/includes/uploadImageForm.html' %}


            <form action="{{action_url}}" method="POST" id="listingForm" enctype="multipart/form-data">
                {% csrf_token %}

                {% comment%}
                    This select element won't be visible to the user, but will be populated by Javascript
                    with the database IDs of any images that the user uploads for the listing. Those will
                    be sent to the server and, if this listing is saved, linked via foreignkey to this new
                    listing.
                {% endcomment %}
                <select class="d-none" name="images" id="selectImageInput" multiple>
                    {% for image in images %}
                        <option value="{{ image.id }}" selected></option>
                    {% endfor %}
                </select>

                {# Display field forms according to the modelform #}
                {% for field in listing_form %}
                    <div class="row mb-4">
                        <div class="col-sm-4">
                            <label for="{{ field.id_for_label }}" class="col-form-label d-block">{{ field.label }}:</label>
                        </div>
                        <div class="col-sm-8">
                            {{ field }} {{ field.help_text }}
                            <div class="text-danger text-small">
                                <ul class="ml-0">
                                    {% for error in field.errors  %}
                                        <li class="text-danger small">{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                {# Display controls for saving/canceling. #}
                <div class="row mb-4">
                    <div class="col col-12">
                        <div class="d-flex">
                            <div><a href="{% url 'index' %}" class="btn btn-outline-danger">Cancel</a></div>
                            {% if form_mode == 'preview' %}
                                <div><a href="{% url 'delete_listing' listing.id %}" class="btn btn-danger ms-3"><i class="bi bi-trash me-1"></i> Delete listing</a></div>
                            {% endif %}
                            <div class="flex-grow-1"></div>
                            <div><button type="submit" class="btn btn-outline-primary" name="preview"><i class="bi bi-save"></i> Save draft</button></div>
                            {% if form_mode == 'preview' %}
                                <div><button type="submit" class="btn btn-primary ms-2" name="post"><i class="bi bi-save-fill ms-3"></i> Save and post</button></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="col-md-2"></div>
    </div>
</div>